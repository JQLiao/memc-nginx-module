Description
    This is an enhanced ngx_memcached module that supports
    get/set/add/delete and more memcached commands.

    This is a non-blocking upstream module and implements
    the latest memcached TCP protocol all by itself.

Status
    The following memcached commands have been implemented
    and tested (with their parameters marked by corresponding
    nginx variables defined by this module):

        get $memc_key
        set $memc_key $memc_flags $memc_exptime $memc_value
        add $memc_key $memc_flags $memc_exptime $memc_value
        replace $memc_key $memc_flags $memc_exptime $memc_value
        append $memc_key $memc_flags $memc_exptime $memc_value
        prepend $memc_key $memc_flags $memc_exptime $memc_value
        delete $memc_key
        delete $memc_key $memc_exptime
        incr $memc_key $memc_value
        decr $memc_key $memc_value
        flush_all
        flush_all $memc_exptime
        stats
        version

    If $memc_value is not defined at all, then the request body
    will be used as the value of the $memc_value except for the
    "incr" and "decr" commands. Note that
    if $memc_value is defined as an empty string (""), that
    empty string will still be used as the value as is.

    All the ngx_memcached directives in nginx 0.8.28 are
    directly inherited.

    In addition, this module also supports the
    "memc_cmds_allowed" directive to control which memcached
    commands are allowed to be executed.

    Support for the "cas" and "stats <args>" commands are
    currently planned in a future release.

    The following commands won't be supported in the future
    unless I find a good reason:

        gets
        verbosity
        quit

    Note that at least memcached version 1.2.2 does not support
    the "append" and "prepend" commands. At least 1.2.4 and later
    versions seem to supports these two commands.

Notes
    The "get" command returns 404 for NOT FOUND response or
    the value of the key $memc_key otherwise. It also sets
    the variable $memc_flags to the flags associated with
    the memcached key.

    The memcached storage commands "set", "add", "replace",
    "prepend", and "append" uses the $memc_key as the key,
    $memc_exptime as the expiration time (or delay) (defaults
    to 0), $memc_flags as the flags (defaults to 0), to build
    the corresponding memcached request.

Examples

    # GET /foo?key=dog
    #
    # POST /foo?key=cat
    # Cat's value...
    #
    # PUT /foo?key=bird
    # Bird's value...
    #
    # DELETE /foo?key=Tiger
    location /foo {
        set $memc_key $arg_key;

        # $memc_cmd defaults to get for GET,
        #   add for POST, set for PUT, and
        #   delete for the DELETE request method.

        memc_pass 127.0.0.1:11211;
    }

    # GET /bar?cmd=get&key=cat
    #
    # POST /bar?cmd=set&key=dog
    # My value for the "dog" key...
    #
    # DELETE /bar?cmd=delete&key=dog
    # GET /bar?cmd=delete&key=dog
    location /bar {
        set $memc_cmd $arg_cmd;
        set $memc_key $arg_key;
        set $memc_flags $arg_flags; # defaults to 0
        set $memc_exptime $arg_exptime; # defaults to 0

        memc_pass 127.0.0.1:11211;
    }

    # GET /bar?cmd=get&key=cat
    # GET /bar?cmd=set&key=dog&val=animal&flags=1234&exptime=2
    # GET /bar?cmd=delete&key=dog
    # GET /bar?cmd=flush_all
    location /bar {
        set $memc_cmd $arg_cmd;
        set $memc_key $arg_key;
        set $memc_value $arg_val;
        set $memc_flags $arg_flags; # defaults to 0
        set $memc_exptime $arg_exptime; # defaults to 0

        memc_cmds_allowed get set add delete flush_all;

        memc_pass 127.0.0.1:11211;
    }

Installation
    Grab the nginx source code from nginx.net (<http://nginx.net/>), for
    example, the version 0.8.28 (see nginx compatibility), and then build
    the source with this module:

        $ wget 'http://sysoev.ru/nginx/nginx-0.8.28.tar.gz'
        $ tar -xzvf nginx-0.8.28.tar.gz
        $ cd nginx-0.8.28/

        # Here we assume you would install you nginx under /opt/nginx/.
        $ ./configure --prefix=/opt/nginx \
            --add-module=/path/to/memc-nginx-module

        $ make -j2
        $ make install

    Download the latest version of the release tarball of this module from
    memc-nginx-module file list
    (<http://github.com/agentzh/memc-nginx-module/downloads>).

Compatibility
    The following versions of Nginx should work with this module:

    *   0.8.x (last tested version is 0.8.28)

    *   0.7.x >= 0.7.46 (last tested version is 0.7.64)

    Some 0.7.x versions older than 0.7.46 might also work, but
    I can't easily test them because the test suite makes
    extensive use of the "echo" module's "echo_location"
    directive, which requires at least nginx 0.7.46 :)

    Earlier versions of Nginx like 0.6.x and 0.5.x will *not* work.

    If you find that any particular version of Nginx above 0.7.63 does not
    work with this module, please consider reporting a bug.

See Also

    *   The Memcached Protocol:
        <http://code.sixapart.com/svn/memcached/trunk/server/doc/protocol.txt>
    *   The standard ngx_memcached module:
        <http://wiki.nginx.org/NginxHttpMemcachedModule>

Author
    agentzh (章亦春) <agentzh at gmail dot com>

